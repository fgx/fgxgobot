<html>
<head>
<title>FGx-go - Experimental</title>

<!-- 
<script type="text/javascript" src="http://cdn.sencha.com/ext-4.1.1-gpl/ext-all.js"></script>
<link rel="stylesheet" href="http://cdn.sencha.com/ext-4.1.1-gpl/resources/css/ext-all.css">
 -->
<script type="text/javascript" src="http://localhost/~libs/ext-4.1.1a/ext-all.js"></script>
<link rel="stylesheet" href="http://localhost/~libs/ext-4.1.1a/resources/css/ext-all.css">

</head>
<body>
<script>


Ext.onReady( function(){

// Our global
var G = {};	


//== Flight Model and Store
Ext.define('Flight', {
    extend: 'Ext.data.Model',
    fields: [
        {name: 'fid',  type: 'string', sortType: "asText"},
        {name: 'model',  type: 'string', sortType: "asUCText"},
        {name: 'callsign',  type: 'string', sortType: "asUCText"},
        {name: 'alt_ft',   type: 'int',sortType: "asInt"},
        {name: 'spd_kt', type: 'int', sortType: "asInt"},
        {name: 'hdg_t', type: 'int', sortType: "asInt"},
        {name: 'lat',  type: 'string'},
        {name: 'lon',  type: 'string'},
    ]
});

Ext.create("Ext.data.JsonStore", {
	model: "Flight",
	storeId: "stoFlights",
	autoLoad: true,
	proxy: {
		type: "ajax",
		url: "/flights",
		reader: {
            type: 'json',
            root: 'flights',
            idProperty: 'callsign' // later FID ?
        }
	},
	
});
Ext.getStore("stoFlights").sort("callsign", "ASC");


//== MpServer Model and Store
Ext.define('MpServer', {
    extend: 'Ext.data.Model',
    fields: [
        {name: 'no',  type: 'int', sortType: "asInt"},
        {name: 'ip',   type: 'string', convert: null, sortType: "asUCText"},
        {name: 'subdomain', type: 'string'},
        {name: 'status', type: 'string'}
    ]
});

Ext.create("Ext.data.JsonStore", {
	model: "MpServer",
	storeId: "stoMpServers",
	autoLoad: true,
	proxy: {
		type: "ajax",
		url: "/mpservers",
		reader: {
            type: 'json',
            root: 'mpservers',
            idProperty: 'no' 
        }
	}
});
Ext.getStore("stoMpServers").sort("subdomain", "ASC");


//= Refresh flight stuff
G.refresh_rate = 0;
G.runner = Ext.create("Ext.util.TaskRunner", {});

function on_refresh_toggled(butt, checked){
	butt.setIconCls( checked ? "icoOn" : "icoOff" );
	
	console.log("checked", checked, butt.refresh_rate)
	//= set new refresh var
	G.refresh_rate = butt.refresh_rate;
	
	//= stop any runners.. but this will/might callback though.. does not cancel sent request..
	G.runner.stopAll();
	
	//= start again with new rate..
	if(G.refresh_rate > 0){
		G.runner.start({
			interval: G.refresh_rate * 1000,
			run: function(){
				Ext.getStore("stoFlights").load()
				 
			}
			//scope: this		
		});
	}
}

	
Ext.create('Ext.container.Viewport', {
    layout: 'border',
    items: [
		{xtype: "panel",
			region: "north",
			frame: false, plain: true, border: false, hideBorders: true,
			margins: {top:0, right:0, bottom:5, left:0},
			hideHeader: true,
			tbar: [
						
				//== Refresh MP
				{xtype: 'tbspacer', width: 20},
				{text: "Refresh Flights Interval >&nbsp;", tooltip: "Refresh now now",
					handler: function(){
						
					}
				},
				{text:  "Off", iconCls: "icoOff", enableToggle: true,   
					width: this.tbw,   allowDepress: false,
					toggleGroup: "refresh_rate",  refresh_rate: 0,  pressed: G.refresh_rate == 0,
					toggleHandler: on_refresh_toggled,	scope: this
				},
	   		   	{text:  "1" ,  iconCls: this.refresh_rate == 1 ? "icoOn" : "icoOff", enableToggle: true,    
					width: this.tbw, allowDepress: false, pressed: G.refresh_rate == 1,
					toggleGroup: "refresh_rate",  refresh_rate: 1, 
					toggleHandler: on_refresh_toggled,	scope: this
				},
	   		   	{text:  "2", iconCls: this.refresh_rate == 2 ? "icoOn" : "icoOff", enableToggle: true,    
					width: this.tbw, allowDepress: false, pressed: G.refresh_rate == 2,
					toggleGroup: "refresh_rate",  refresh_rate: 2, 
					toggleHandler: on_refresh_toggled,	scope: this
				},
	   			{text:  "3", iconCls: this.refresh_rate == 3 ? "icoOn" : "icoOff", enableToggle: true,   
					width: this.tbw, allowDepress: false,  pressed: G.refresh_rate == 3,
					toggleGroup: "refresh_rate",  refresh_rate: 3, 
					toggleHandler: on_refresh_toggled,	scope: this
				},
	   			{text:  "6", iconCls: this.refresh_rate == 6 ? "icoOn" : "icoOff", enableToggle: true,   
					width: this.tbw, allowDepress: false, pressed: G.refresh_rate == 6,
					toggleGroup: "refresh_rate",  refresh_rate: 6,
					toggleHandler: on_refresh_toggled,	scope: this
				},
	   			{text:  "10", iconCls: this.refresh_rate == 10 ? "icoOn" : "icoOff", enableToggle: true,   
					width: this.tbw, allowDepress: false, pressed: G.refresh_rate == 10,
					toggleGroup: "refresh_rate",  refresh_rate: 10, 
					toggleHandler: on_refresh_toggled,	scope: this
				},
				"-",
				"->",
		
				//== FlightGear Menu
				"-",
				{text: "FlightGear", iconCls: "icoFlightGear", disabled: true
				
				},
				"-",	
				
				//== FGx Menu
				{text: "FGx", iconCls: "icoFgx", 
					menu: [
						{text: "Issues", url: "https://github.com/fgx/fgx-go/issues",
							handler: this.on_open_url, scope: this,
						},
						{text: "Git View", url: "https://github.com/fgx/fgx-go",
							handler: this.on_open_url, scope: this 
						}
					]
				},
				{xtype: 'tbspacer', width: 10}
						
				]
			}			, /* {
	        region: 'west',
	        collapsible: true,
	        title: 'Navigation',
	        width: 150
	        // could use a TreePanel or AccordionLayout for navigational items
	    }, */
	    Ext.create("Ext.grid.Panel", {
	    	title: "Mp Servers",
	    	region: "west",
	    	collapsible: true,
	    	width: 400,
	    	store: Ext.getStore("stoMpServers"),
	    	viewConfig: {
	    		emptyText: "No flights in this view",
	    		deferEmpty: false
	    	},
	        columns: [
				{text: 'No',  dataIndex: 'no', menuDisabled: true, width: 50},
	            {text: 'MpServer',  dataIndex: 'subdomain', menuDisabled: true, flex: 1},
	            {text: 'Ip', dataIndex: 'ip', flex: 1, menuDisabled: true, flex: 1},
	            {text: 'Status', dataIndex: 'status', menuDisabled: true, flex: 1}
	        ],
	        dockedItems: [
				{xtype: 'pagingtoolbar',
	            	store: Ext.getStore("stoMpServers"), 
	            	dock: 'bottom', displayInfo: true
	        	}
			]
	    }),
	    
	    /*{
	        region: 'south',
	        title: 'South Panel',
	        collapsible: true,
	        html: 'Information goes here',
	        split: true,
	        height: 100,
	        minHeight: 100
	    },*/
	    
	    Ext.create('Ext.chart.Chart', {
            id: 'chartCmp',
            region: "south",
            height: 300,
            xtype: 'chart',
            style: 'background:#fff',
            animate: true,
            shadow: true,
            store: Ext.getStore("stoFlights"),
            axes: [
				{
	                type: 'Numeric',
	                position: 'left',
	                fields: ['alt_ft'],
	                label: {
	                    renderer: Ext.util.Format.numberRenderer('0,0')
	                },
	                title: 'Altitude',
	                grid: true,
	                minimum: 0
	            }, {
	                type: 'Category',
	                position: 'bottom',
	                fields: ['callsign'],
	                title: 'Flight'
	            }
            ],
            series: [
				{
                type: 'column',
                axis: 'left',
                highlight: true,
                tips: {
                  trackMouse: true,
                  width: 140,
                  height: 28,
                  renderer: function(storeItem, item) {
                    this.setTitle(storeItem.get('callsign') + ': ' + storeItem.get('alt_ft') + ' ft');
                  }
                },
                label: {
                  display: 'insideEnd',
                  'text-anchor': 'middle',
                    field: 'data1',
                    renderer: Ext.util.Format.numberRenderer('0'),
                    orientation: 'vertical',
                    color: '#333'
                },
                xField: 'callsign',
                yField: 'alt_ft'
            }]
	    }),
	    {
	        region: 'east',
	        title: 'East Panel',
	        collapsible: true,
	        split: true,
	        width: 150
	    }, 
	    /*{
	        region: 'center',
	        xtype: 'tabpanel', // TabPanel itself has no title
	        activeTab: 0,      // First tab active by default
	        items: {
	            title: 'Default Tab',
	            html: 'The first tab\'s content. Others may be added dynamically'
	        }*/
	    Ext.create("Ext.grid.Panel", {
	    	title: "Flights",
	    	region: "center",
	    	store: Ext.getStore("stoFlights"),
	    	viewConfig: {
	    		emptyText: "No flights in this view",
	    		deferEmpty: false
	    	},
	        columns: [
	            {text: 'Callsign',  dataIndex: 'callsign', width: 100, menuDisabled: true,
	            	renderer: function(v, meta, rec){
	            		meta.style = "font-weight: bold;";
	            		return v;
	            	}
	            },
	            {text: 'Alt Ft', dataIndex: 'alt_ft', flex: 1, align: "right", menuDisabled: true},
	            {text: 'Spd Kt', dataIndex: 'spd_kt', flex: 1, align: "right", menuDisabled: true},
	            {text: 'Hdg True', dataIndex: 'hdg_t', flex: 1, align: "right", menuDisabled: true},
	            {text: 'Lat', dataIndex: 'lat', flex: 1, align: "right", menuDisabled: true},
	            {text: 'Lon', dataIndex: 'lon', flex: 1, align: "right", menuDisabled: true},
	            {text: 'Model', dataIndex: 'model', flex: 2, align: "left", menuDisabled: true}
	        ],
	        dockedItems: [
				{xtype: 'pagingtoolbar',
	            	store: Ext.getStore("stoFlights"), 
	            	dock: 'bottom', displayInfo: true
	        	}
			]
	    })
	    
    ]
}) // << Ext.create('Ext.container.Viewport'

});
</script>

</body>
</html>